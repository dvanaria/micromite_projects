CONST DAT_OUT = 2
CONST DAT_IN = 26
CONST SCLK = 4
CONST RST = 6

SETPIN DAT_OUT, DOUT
PRINT "Pin 2 set to DIGITAL OUT, connected to DS1302's DAT"
SETPIN DAT_IN, DIN
PRINT "Pin 26 set to DIGITAL IN, connected to DS1302's DAT"
SETPIN SCLK, DOUT
PRINT "Pin 4 set to DIGITAL OUT, connected to DS1302's SCLK"
SETPIN RST, DOUT
PRINT "Pin 6 set to DIGITAL OUT, connected to DS1302's RST"

REM NOTE: THE INPUT PIN ON THE VMA301 MODULE LABELED "RST" IS FED 
  '       DIRECTLY TO THE DS1302'S ~RST PIN, SO = 0 PRE-INITIALIZATION, 
  '       THEN SET = 1 TO INITIALIZE A DATA TRANSFER (2 BYTES)

REM NOTE: DS1302: "DATA IS SERIALLY INPUT ON THE RISING EDGE OF THE SCLK"
  '       SO MAKE SURE TO SET DAT_OUT VALUE BEFORE SETTING SCLK = 1

REM NOTE: 

DIM INTEGER MS1 = 30

DIM INTEGER COMMAND_SET_YEAR(7)  = (1,0,0,0,1,1,0,0) 
DIM INTEGER COMMAND_READ_YEAR(7) = (1,0,0,0,1,1,0,1)  

DIM INTEGER SET_YEAR(7)          = (0,1,0,1,0,1,1,1) ' YEAR = 57

DIM INTEGER RECEIVE_YEAR(7)      = (1,1,1,0,0,1,1,1)

  PRINT "INITIALIZING DATA TRANSFER TO DS1302"
  PIN(DAT_OUT) = 0  
  PIN(SCLK) = 0  :  ' SCLK must be 0 before initiating transfer
  PIN(RST) = 0
  PAUSE MS1

  PIN(RST) = 1  :  ' This intiates transfer, setting ~RST to 1
  PAUSE MS1

  PRINT "SENDING COMMAND BYTE: 'WRITE TO REGISTER'"
  FOR I = 0 TO 7
    PIN(DAT_OUT) = COMMAND_SET_YEAR(I)
    PAUSE MS1
    PIN(SCLK) = 1
    PAUSE MS1
    PIN(SCLK) = 0
    PAUSE MS1
  NEXT I  

  PRINT "WRITING TO REGISTER"
  FOR I = 0 TO 7
    PIN(DAT_OUT) = SET_YEAR(I)
    PAUSE MS1
    PIN(SCLK) = 1
    PAUSE MS1
    PIN(SCLK) = 0
    PAUSE MS1
  NEXT I  

  PRINT "END OF FIRST TRANSFER (WRITE)"
  PIN(RST) = 0  :  ' This ENDS first transfer, setting ~RST to 0
  PAUSE MS1
  
  PIN(DAT_OUT) = 0  
  PIN(SCLK) = 0  :  ' SCLK must be 0 before initiating transfer
  PAUSE MS1

  PIN(RST) = 1  :  ' This intiates transfer, setting ~RST to 1
  PAUSE MS1

  PRINT "SENDING COMMAND BYTE: 'READ REGISTER'"
  FOR I = 0 TO 7
    PIN(DAT_OUT) = COMMAND_READ_YEAR(I)
    PAUSE MS1
    PIN(SCLK) = 1
    PAUSE MS1
    PIN(SCLK) = 0
    PAUSE MS1
  NEXT I 

  PRINT "READING DATA: ";
  FOR I = 0 TO 7
    PIN(SCLK) = 1
    PAUSE MS1
    PIN(SCLK) = 0
    PAUSE MS1
    RECEIVE_YEAR(I) = PIN(DAT_IN)
    PAUSE MS1
  NEXT I

  PRINT
  PRINT "RESULTS: ";
  FOR I = 7 TO 0 STEP -1
    PRINT RECEIVE_YEAR(I);
  NEXT I
 
END