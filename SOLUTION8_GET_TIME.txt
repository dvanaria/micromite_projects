'DS1302 signal to PIC32 pin
CONST DAT  = 2
CONST SCLK = 4
CONST RST  = 6

SETPIN DAT,  DOUT
SETPIN SCLK, DOUT
SETPIN RST,  DOUT

'Time to pause to generate waveforms
DIM INTEGER MS_PAUSE = 3

'Array to capture read from DS1302 registers
DIM INTEGER INPUT_DATA(7)

'Taken from DS1302 datasheet
DIM INTEGER COMMAND_READ_SEC(7)   = (1,0,0,0,0,0,0,1)
DIM INTEGER COMMAND_READ_MIN(7)   = (1,0,0,0,0,0,1,1)
DIM INTEGER COMMAND_READ_HOUR(7)  = (1,0,0,0,0,1,0,1)
DIM INTEGER COMMAND_READ_DATE(7)  = (1,0,0,0,0,1,1,1)
DIM INTEGER COMMAND_READ_MONTH(7) = (1,0,0,0,1,0,0,1)
DIM INTEGER COMMAND_READ_DAY(7)   = (1,0,0,0,1,0,1,1)
DIM INTEGER COMMAND_READ_YEAR(7)  = (1,0,0,0,1,1,0,1)


REM **** PROGRAM ****
READ_TRANSFER COMMAND_READ_SEC()
  PRINT "SEC: ",;
  PRINT_PAYLOAD
  PRINT "   ";
  PRINT_BCD INPUT_DATA()
READ_TRANSFER COMMAND_READ_MIN()
  PRINT "MIN: ",;
  PRINT_PAYLOAD
  PRINT "   ";
  PRINT_BCD INPUT_DATA()
READ_TRANSFER COMMAND_READ_HOUR()
  PRINT "HOUR: ",;
  PRINT_PAYLOAD
  PRINT "   ";
  PRINT_BCD INPUT_DATA()
READ_TRANSFER COMMAND_READ_DATE()
  PRINT "DATE: ",;
  PRINT_PAYLOAD
  PRINT "   ";
  PRINT_BCD INPUT_DATA()
READ_TRANSFER COMMAND_READ_MONTH()
  PRINT "MONTH: ",;
  PRINT_PAYLOAD
  PRINT "   ";
  PRINT_BCD INPUT_DATA()
READ_TRANSFER COMMAND_READ_DAY()
  PRINT "DAY: ",;
  PRINT_PAYLOAD
  PRINT "   ";
  PRINT_BCD INPUT_DATA()
READ_TRANSFER COMMAND_READ_YEAR()
  PRINT "YEAR: ",;
  PRINT_PAYLOAD
  PRINT "   ";
  PRINT_BCD INPUT_DATA()
END 



SUB PRINT_PAYLOAD
  FOR I = 0 TO 7
    PRINT INPUT_DATA(I);
  NEXT I
END SUB

SUB PRINT_BCD N%()
  LOCAL INTEGER HIGH = 0
  LOCAL INTEGER LOW  = 0
  LOCAL INTEGER RESULT = 0
  HIGH = HIGH + N%(0)*8
  HIGH = HIGH + N%(1)*4
  HIGH = HIGH + N%(2)*2
  HIGH = HIGH + N%(3)*1
  LOW  = LOW  + N%(4)*8
  LOW  = LOW  + N%(5)*4
  LOW  = LOW  + N%(6)*2
  LOW  = LOW  + N%(7)*1
  RESULT = HIGH*10 + LOW
  PRINT_PCB = RESULT
  PRINT RESULT
END SUB

  



SUB READ_TRANSFER COMMAND_BYTE_READ_REG%()

  SETPIN DAT, DOUT
  PAUSE MS_PAUSE

  ' initialize READ transfer
  PIN(DAT)  = 0  
  PIN(SCLK) = 0  :  ' SCLK must be 0 before initiating transfer
  PIN(RST)  = 0
  PAUSE MS_PAUSE

  ' begin transfer
  PIN(RST)  = 1  :   ' This intiates transfer, setting ~RST to 1
  PAUSE MS_PAUSE

  ' send command byte to READ from DS1302 register
  FOR I = 7 TO 0 STEP -1
    PIN(DAT) = COMMAND_BYTE_READ_REG%(I)
    PAUSE MS_PAUSE
    PIN(SCLK) = 1
    PAUSE MS_PAUSE
    IF I <> 0 THEN   ' DON'T SET CLOCK TO 0 AFTER LAST COMMAND BIT
      PIN(SCLK) = 0
      PAUSE MS_PAUSE
    ENDIF
  NEXT I 
  
  SETPIN DAT, DIN, PULLUP
  PAUSE MS_PAUSE

  ' read data coming in from DS1302
  FOR I = 7 TO 0 STEP -1
    IF I <> 7 THEN
      PIN(SCLK) = 1
      PAUSE MS_PAUSE
    ENDIF
    PIN(SCLK) = 0
    PAUSE MS_PAUSE
    INPUT_DATA(I) = PIN(DAT)
    PAUSE MS_PAUSE
  NEXT I

END SUB